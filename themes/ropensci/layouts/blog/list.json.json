{{ $data := newScratch }}
{{ $pages := .Site.Pages.ByPublishDate.Reverse }}
{{ $data.Set "pages" $pages }}
{{ $data.Set "permalink" .Permalink }}
{
    "version": "https://jsonfeed.org/version/1.1",
    "title": "{{ .Site.Title }}",
    "favicon": "{{ .Permalink}}/apple-touch-icon.png",
    "home_page_url": "{{ .Permalink }}",
    "feed_url": "{{ .Permalink}}/index.json",
	{{ if isset .Site.Params "description" }}
	"description": "{{ .Site.Params.description }}",
	{{ end }}
	{{ if isset .Site.Params "author" }}
	"author": { "name": "{{ .Site.Params.author }}" },
	{{ end }}
    "items": [
    {{ range $i, $e := ( where .Pages ".Date.UTC" "<" now.UTC ) }}
		{{ if $i }}, {{ end }}
  		{{ if eq (substr (jsonify .Params.author) 0 1) "[" }}
        {{ $data.Set "authors" .Params.author }}
     {{ else }}
       {{  $data.Set "authors" (slice .Params.author) }}
    {{ end }}
			{
				"id": "{{ .Permalink }}",
				"title": "{{ .Title }}",
				"language" : "{{ .Lang }}",
				"authors": [{{ range $i, $e := ($data.Get "authors") }}{{ range first 1 (where ($data.Get "pages") ".Params.name" $e) }}{{ $params := .Params }}{{ $name := $params.name }}{{ if $i }}, {{ end }}{{ range first 1 (where ($data.Get "pages") ".Params.name" $e) }}
				{
      "name": "{{ $name }}",
      "url": "{{ if isset .Params "orcid" }}https://orcid.org/{{ .Params.orcid }} {{ else }} {{ .Permalink }} {{ end }}",
      "avatar": "{{ ( partial "blogs/author-img" . ) }}"
    }{{ end }}{{ end }}{{ end }}],
				"tags": {{ .Params.tags | jsonify}},
				"content_html": "{{ .Content | replaceRE `"` `\"` | replaceRE "\n" "" | replaceRE "(\\s)" " " }}",
				"url": "{{ .Permalink }}",
				"date_published": "{{ .Date.Format "2006-01-02T15:04:05-07:00" | safeHTML }}",
				"date_modified": "{{ .Lastmod.Format "2006-01-02T15:04:05-07:00" | safeHTML }}"
			}
		{{ end }}
    ]
}