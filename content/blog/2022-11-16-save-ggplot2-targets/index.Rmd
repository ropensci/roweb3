---
slug: "save-ggplot2-targets"
title: How to Save ggplot2 plots in a targets Workflow?
author:
  - Matthias Greni√©
# Set the date below to the publication date of your post
date: 2020-03-10
# Minimal tags for a post about a community-contributed package 
# that has passed software peer review are listed below
# Consult the Technical Guidelines for information on choosing tags
tags:
  - targets
  - ggplot2
  - workflow
  - tech notes
# The summary below will be used by e.g. Twitter cards
description: "A very short summary of your post (~ 100 characters)"
# If you have no preferred image for Twitter cards,
# delete the twitterImg and twitterAlt lines below 
# - Replace "blog" with "technotes" as needed
# - Note no "/" symbol before "blog" here
# - Note "/" between year/month/day
twitterImg: blog/2019/06/04/post-template/name-of-image.png
twitterAlt: "Alternative description of the image"
# the text below is for populating the "share on Twitter" button
# if deleted, the title of the post will be used
tweet: "A post about blabla by @username!"
---

```{r setup, include=FALSE}
# Options to have images saved in the post folder
# And to disable symbols before output
knitr::opts_chunk$set(fig.path = "", comment = "")

# knitr hook to make images output use Hugo options
knitr::knit_hooks$set(
  plot = function(x, options) {
    hugoopts <- options$hugoopts
    paste0(
      "{{<figure src=",
      '"', x, '" ',
      if (!is.null(hugoopts)) {
        glue::glue_collapse(
          glue::glue('{names(hugoopts)}="{hugoopts}"'),
          sep = " "
        )
      },
      ">}}\n"
    )
  }
)

# knitr hook to use Hugo highlighting options
knitr::knit_hooks$set(
  source = function(x, options) {
  hlopts <- options$hlopts
    paste0(
      "```r ",
      if (!is.null(hlopts)) {
      paste0("{",
        glue::glue_collapse(
          glue::glue('{names(hlopts)}={hlopts}'),
          sep = ","
        ), "}"
        )
      },
      "\n", glue::glue_collapse(x, sep = "\n"), "\n```\n"
    )
  }
)
```

Citation of the primary literature[^1]. 

Citation of a website[^2]. 

Citation of an R package[^3].

### Subsection heading

We recommend the use of [Hugo shortcodes](https://gohugo.io/content-management/shortcodes/) to include images, tweets, videos, gists, etc. In the Rmd file they need to be between `<!--html_preserve-->` and `<!--/html_preserve-->`.

**Add an image** by using a Hugo shortcode. The image is saved under `/content/blog/YYYY-MM-DD-slug/name-of-image.png`.

<!--html_preserve-->
{{< figure src = "name-of-image.png" width = "400" alt = "this is the alternative text" >}}
<!--/html_preserve-->

Below is another image, a plot generated by a code chunk, so you might see how to add alternative text and other options in this case. You can also use [all options documented for the figure shortcode](https://gohugo.io/content-management/shortcodes/#figure) except for `src` that will be created automatically when knitting.

```{r chunkname, hugoopts=list(alt="alternative text please make it informative", caption="this is what this image shows, write it here or in the paragraph after the image as you prefer", width=300)}
plot(1:10)
```

Once this file is knitted the plot above will be inserted with the correct syntax.
<!--html_preserve-->
{{< tweet user="SanDiegoZoo" id="1453110110599868418" >}}
<!--/html_preserve-->

I really enjoy using [`targets`](https://doc.ropensci.org/targets) for all of my data analysis projects. They help me structure all of the projects nicely in the same folder. For them I often produce several figures using `ggplot2`. I want to keep my plots accessible to be able to revisit them anytime and to assemble them with `patchwork` into more complex figures for a potential paper. In a regular project I generate 10 to 20 figures, some only diagnostic ones and some final polished one for the potential finished manuscript. I do revisit the list of figures often, as co-authors or reviewers ask me for more detailed analyses and visualizations.

In most cases, I don't know before hand the sizes of the figures, so I like to save the ggplot2 plots as R objects and not images in my `targets` workflow. I sometimes edit them for a presentation, a paper, or a poster, so I like to the flexibility of saving them as R objects.

However, there are no formal recommendations to save ggplot2 objects in targets workflow. These can have different consequences for the size of stored cache, the loading time, the flexibility, and ease of use of the plots.

In this blog post I explore the different possible options and discuss their pros and cons, with some insights from both `ggplot2` and `targets` communities. I will show the consequences of using each one of them through a simple workflow making a plot with the `mtcars` dataset.


## First solution: saving the entire `ggplot2` objects without worrying

My first solution was to not worry about the plots and leverage the very clever system from targets that saves object.

Let's say our workflow loads the data and make a simple plot:

```{r first-workflow}
# Create a simple demo workflow
tar_script({
  library("ggplot2")
  library("targets")
  
  list(
    tar_target(mtcars_df, mtcars),
    tar_target(
      simple_plot,
      ggplot(mtcars_df, aes(cyl, mpg)) +
        geom_point()
    )
  )
}, ask = FALSE)

# Run the workflow
tar_make()
```

Then if you want to access the plot you can use `tar_read()` or `tar_load()` and you'll get back a modifiable ggplot2 object

```{r first-load-plot}
tar_read(simple_plot)

# It's modifiable (we can add a theme after the fact)
tar_read(simple_plot) +
  theme_bw()
```

For now, the plot is pretty simple and low weight. We'll be using the `obj_size()` function from  `lobstr` package to evaluate the package size.

```{r first-size}
lobstr::obj_size(tar_read(simple_plot))
```

### Pros

* Works out of the box
* Have nothing to worry about
* Flexible with the size of the plots

### Cons

* Increased saved object size (and thus workflow size)
* If object is big, than slow to load
* 


## Second (partial) solution: transform ggplot2 objects into grobs using target hooks

Learnt about target hooks.

But not recommended at all by ggplot2 folks. Risk of being very brittle. Didn't work as well. Was less clear to manipulate them.

Do this are you own risk (if you really know about `grid` and `Grob`s probably)


### Pros

* Very lightweight total
* Flexible in the final size of the image
* Leverages the amazing (and not so known) hooks in a targets workflow

### Cons

* Can't edit the ggplot2 object after the fact
* Has to add a post-hook to the `targets` workflow.
* Officially not recommended by ggplot2 maintainers.
* `grid` objects can be strange to work with


## Third solution: save the plots as images

With or without `targets` hooks.
When asked on rOpenSci Slack, some people mentioned they were always saving the plots as images. This can also work (maybe also with a hook), though you need to know the dimensions you're saving the objects to in advance.


### Pros

* Lightweight
* Easy file type

### Cons

* Fixed size a priori
* Can't edit easily the object after the fact



## Fourth (& final) solution: save `ggplot2` objects but thin the plotting environment

example of plot and change in size of object. (Where are we getting)

Need to care about whatever is floating around when creating

### Pros

* Works out of the box
* No need to fiddle with the workflow
* Lighter file size
* Flexible image size
* Can edit object after the fact

### Cons

* Have to edit carefully what's happening in the plotting functions


## Summary

We explored solutions to save ggplot2 objects in target workflows:

* Saving `ggplot2` objects directly without consideration may accidentally save bigger objects because it saves the plot environment
* `targets` hooks can help you post-process targets automatically
* Saving `ggplot2` as `Grob` is not recommended and shouldn't be done
* The solution is to save `ggplot2` and thinning any object that may be staying in the environment


## Conclusion


## Citation

**Add citation or footnote** text by using the format below 

[^1]: Sciaini, M., Fritsch, M., Scherer, C., & Simpkins, C. E. (2018). NLMR and landscapetools: An integrated environment for simulating and modifying neutral landscape models in R. Methods in Ecology and Evolution, 9(11), 2240-2248. <https://doi.org/10.1111/2041-210X.13076>
[^2]: Elin Waring, Michael Quinn, Amelia McNamara, Eduardo Arino de la Rubia, Hao Zhu and Shannon Ellis (2019). skimr: Compact and Flexible Summaries of Data. R package version 1.0.7. https://CRAN.R-project.org/package=skimr
[^3]: Hugo static site generator. https://gohugo.io/