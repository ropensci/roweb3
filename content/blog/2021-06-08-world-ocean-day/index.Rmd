---
slug: "world-ocean-day"
title: Celebrating World Ocean Day rOpenSci Style
# Delete the package_version line below if your post is not about a package
package_version: 0.1.0
author:
  - Steffi LaZerte
# Set the date below to the publication date of your post
date: 2021-06-08
# Minimal tags for a post about a community-contributed package 
# that has passed software peer review are listed below
# Consult the Technical Guidelines for information on choosing tags
tags:
  - Software Peer Review
  - packages
  - R
  - community
# The summary below will be used by e.g. Twitter cards
description: "A very short summary of your post (~ 100 characters)"
# If you have no preferred image for Twitter cards,
# delete the twitterImg and twitterAlt lines below 
# - Replace "blog" with "technotes" as needed
# - Note no "/" symbol before "blog" here
# - Note "/" between year/month/day
twitterImg: blog/2019/06/04/post-template/name-of-image.png
twitterAlt: "Alternative description of the image"
# the text below is for populating the "share on Twitter" button
# if deleted, the title of the post will be used
tweet: "A post about blabla by @username!"
# 'output' is necessary to obtain index.md
# Do not commit index.html
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
# Options to have images saved in the post folder
# And to disable symbols before output
knitr::opts_chunk$set(fig.path = "", comment = "")

# knitr hook to make images output use Hugo options
knitr::knit_hooks$set(
  plot = function(x, options) {
    hugoopts <- options$hugoopts
    paste0(
      "{{<figure src=",
      '"', x, '" ',
      if (!is.null(hugoopts)) {
        glue::glue_collapse(
          glue::glue('{names(hugoopts)}="{hugoopts}"'),
          sep = " "
        )
      },
      ">}}\n"
    )
  }
)

# knitr hook to use Hugo highlighting options
knitr::knit_hooks$set(
  source = function(x, options) {
  hlopts <- options$hlopts
    paste0(
      "```r ",
      if (!is.null(hlopts)) {
      paste0("{",
        glue::glue_collapse(
          glue::glue('{names(hlopts)}={hlopts}'),
          sep = ","
        ), "}"
        )
      },
      "\n", glue::glue_collapse(x, sep = "\n"), "\n```\n"
    )
  }
)
```

**Happy [World Ocean Day](https://worldoceanday.org/)!**

[World Ocean Day](https://worldoceanday.org/) is a day of celebration and action to protect our shared ocean. 
My background in biology (and animal behaviour) and my enthusiasm for nature and the outdoors definitely help feel the value of protecting important ecosystems,
but the idea that we have one ocean and it connects us all is something I find particularly meaningful. 
I find this especially so now when many of us feel isolated and emotionally exhausted. 

So in honour of World Ocean Day, let's take a look at some important ocean metrics using open data and open softare via rOpenSci packages!

Last September the Arctic sea ice had the 2nd-lowest extent in a 40-year record[^1]. 
This isn't good `r emo::ji("sad")` for the Arctic ecosystem and has impacts not only on wildlife but on humans as well[^2]. 

Let's see if we can't explore this phenomenon ourselves using open data and open source packages part of the [rOpenSci collections](https://ropensci.org/packages).

Specifically, I want to look at sea ice extent and map it.
We'll use two rOpenSci packages:
- [rnoaa](https://docs.ropensci.org/rnoaa) package to access NOAA data on sea ice coverage
- [rnaturalearth](https://docs.ropensci.org/rnaturalearth) package to get coastal outlines for context

We'll also use sf for handling spatial data, dplyr for data manipulation, and ggplot2 for plotting. 
And finally, because I can be lazy, we'll use purrr for easy-to-use apply functions.

```{r, message = FALSE}
library(rnoaa)
library(rnaturalearth)

library(sf)
library(ggplot2)
library(dplyr)
library(purrr)
```

Let's get some ice data! 
We'll use the `sea_ice()` function to grab data on ice extent for every 5 years from 1980 to 2020 (`year = seq(1980, 2020, 5)`), in September (`month = "Sep"`), and for the Arctic (North) (`pole = "N"`).

```{r, message = FALSE}
ice <- sea_ice(year = seq(1980, 2020, 5), month = "Sep", pole = "N")
map(ice[1:2], head) # Just to look at the head of the first two years worth of data
```

This results in a list of fortified data frames which you could plot using `geom_polygon()`. 
But I want to get the projection right, so let's bind the rows together (adding year as a parameter) and convert to an sf object. 

We'll use the EPSG (projection) of 3411 which is for "NSIDC Sea Ice Polar Stereographic North", and is used by NOAA for Sea Ice[^3].

```{r}
ice_sf <- ice %>%
  bind_rows(.id = "year") %>%
  mutate(year = factor(year, labels = seq(1980, 2020, 5))) %>%
  st_as_sf(coords = c("long", "lat"), crs = 3411)
ice_sf
```

This results in a collection of points, so we'll want to `summarize()` the data into multipoints by year and group, and then cast into polygons.

```{r}
ice_sf <- ice_sf %>%
  group_by(year, group) %>%
  summarize(do_union = FALSE, .groups = "drop") %>%
  st_cast(to = "POLYGON")
ice_sf
```

Here it's important to use `do_union = FALSE` because we don't want the order of the points to change (otherwise when we plot we'll get [@accidental__aRt](https://twitter.com/accidental__aRt)!)

<!--html_preserve-->
{{< tweet 1374726320047980549 >}}
<!--/html_preserve-->


Let's take a peak at what we've got

```{r}
ggplot() +
  theme_minimal() +
  geom_sf(data = ice_sf, aes(fill = year), colour = NA)
```

Oooo very nice! But a couple of points could be improved

- It's a bit hard to understand the context because there's no land
- Some points up around ~45 degrees North look *highly* improbable for sea ice
- I think we can do better than ggplot2 default colours `r emo::ji("grin")`

First we'll crop out that questionable data. 
We can see the extent of the data with `st_bbox()`.
```{r}
st_bbox(ice_sf)
```

It seems like that high ymax value is probably the culprit.
In the figure above, the y extents (circular axes) look roughly symmetrical.
So, let's do a rough crop and see where it gets us.
Note that I'm also using `st_make_valid()` to fix a bit of ring self-intersection that pops up as an error otherwise.

```{r}
ice_sf <- ice_sf %>%
  st_make_valid() %>%
  st_crop(xmin = -2550000, ymin = -3250000, xmax = 2350000, ymax = 3500000)

ggplot() +
  theme_minimal() +
  geom_sf(data = ice_sf, aes(fill = year), colour = NA)
```

Much better! There are definitely more precise and sophisticated ways of filtering or cropping spatial data, but this will do for now.

Next, let's get the coastline spatial data using rnaturalearth's function `ne_coastlines()`.
We'll get medium quality, return it as `sf`, then transform and crop to match the projection and extent of our ice data.

```{r}
coast <- ne_coastline(scale = "medium", returnclass = "sf") %>%
  st_transform(crs = st_crs(ice_sf)) %>%
  st_crop(st_bbox(ice_sf))
```

Now let's take another stab at mapping, using the coastline data as well as viridis scales.
```{r}
ggplot() +
  theme_minimal() +
  geom_sf(data = ice_sf, aes(fill = year), colour = NA) +
  geom_sf(data = coast) +
  scale_fill_viridis_d(option = "inferno", begin = 0.1, end = 0.9)
```

From here, it's very apparent how much the ice extent in September has changed over the years.
There's been a fair amount of reduction especially along Russia's (top and top right) and Alaska's (left) coasts, and among Canada's Arctic Archipelago (bottom left). 

This isn't great news, and it's not new news, but as World Ocean Day is about calls to action, specifically for proecting [30% protection of the oceans by 2030](https://worldoceanday.org/take-action/conservation-action-focus/), it's always worth the reminder. 


## Leopard seals
One of my favourite videos is a [TED Talk by Paul Nicklen: Animal tales from icy wonderlands](https://www.ted.com/talks/paul_nicklen_animal_tales_from_icy_wonderlands?utm_campaign=tedspread&utm_medium=referral&utm_source=tedcomshare). It's a fantastic view of life in the polar oceans and an amazing story of a photographer and a leopard seal. 

So in honour of this wonderful story, let's take a different approach and look at leopard seals! 

<!--html_preserve-->
{{< figure src = "leopard_seal.jpg", alt = "Leopard seal lying on ice"), class = "center" href = "https://commons.wikimedia.org/wiki/File:Antarctic_Sound-2016-Brown_Bluff%E2%80%93Leopard_seal_(Hydrurga_leptonyx)_04.jpg">}}
<!--/html_preserve-->

Andrew Shiva / Wikipedia / CC BY-SA 4.0

```{r, message = FALSE}
library(robis)
library(stringr)
library(lubridate)

seals <- occurrence(scientificname = "Hydrurga leptonyx")
seals
```

```{r}
seals_sf <- seals %>%
  select(eventDate, datasetName, individualCount, decimalLongitude, decimalLatitude) %>%
  filter(decimalLatitude < -55, !is.na(eventDate)) %>%
  mutate(year = as.numeric(str_extract(eventDate, "[0-9]{4}"))) %>%
  st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), crs = 4326) %>%
  st_transform(3412)
```


```{r}
antarctic <- ne_countries(returnclass = "sf") %>%
  st_transform(3412) %>%
  st_make_valid() %>%
  st_crop(st_bbox(seals_sf))

ggplot() +
  geom_sf(data = antarctic, fill = "grey") +
  geom_sf(data = seals_sf, aes(colour = year)) +
  geom_sf_text(data = filter(seals_sf, year < 1950), aes(label= year), hjust = 1.1) +
  scale_colour_viridis_c(end = 0.85)
```

Wow! There are some really old observations here, let's see where they're coming from
```{r}
filter(seals_sf, year < 1950) %>%
  select(year, datasetName) %>%
  st_drop_geometry() %>%
  arrange(year)
```

What about the more recent observations?
```{r}
filter(seals_sf, year > 2000) %>%
  pull(datasetName) %>%
  unique()
```

Happywhale? I'd never head of this before, but 

## Interested in learning more about these awesome packages?

- robis blog
- etc.
- etc.

## Have your own use cases?
We'd love to share them!
Go to forum ...
we tweet....


[^1]: Arctic Report Card: Update for 2020 <https://arctic.noaa.gov/Report-Card/Report-Card-2020/ArtMID/7975/ArticleID/891/Sea-Ice>
[^2]: Six ways loss of Arctic ice impacts everyone <https://www.worldwildlife.org/pages/six-ways-loss-of-arctic-ice-impacts-everyone>
[^3]: See the "User Guide" at the Sea Ice data page <https://nsidc.org/data/g02135>